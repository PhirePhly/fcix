#!/bin/bash
#
# gen_bird_conf - Generates configuration files for BIRD route servers
# Kenneth Finnegan, 2018

cat <<EOF >conf/RS1.bird.conf
#
# Route Server Conf - Generated by FCIX config script
#
log syslog all;
timeformat protocol "%s";

# Override router ID
router id 44.74.128.253;
protocol kernel {
 import none;
 export none;
}

# This pseudo-protocol watches all interface up/down events.
protocol device {
}

template bgp template_rspeer {
 local as 4244741280;
 source address 44.74.128.253;
 import all;
 export all;
 import keep filtered;
 import limit 10000 action restart;
 rs client;
 passive on;
 interpret communities off;
}

# Begin per peer config
EOF

cat <<EOF >conf/RS1.bird6.conf
#
# Route Server Conf - Generated by FCIX config script
#
log syslog all;
timeformat protocol "%s";

# Override router ID
router id 44.74.128.253;
protocol kernel {
 import none;
 export none;
}

# This pseudo-protocol watches all interface up/down events.
protocol device {
}

template bgp template_rspeer {
 local as 4244741280;
 source address 2607:7C80:55:128::253;
 import all;
 export all;
 import keep filtered;
 import limit 10000 action restart;
 rs client;
 passive on;
 interpret communities off;
}

# Begin per peer config
EOF


sed "s/44.74.128.253/44.74.128.254/g" conf/RS1.bird.conf >conf/RS2.bird.conf
sed "s/44.74.128.253/44.74.128.254/g; s/2607:7C80:55:128::253/2607:7C80:55:128::254/g" conf/RS1.bird6.conf >conf/RS2.bird6.conf

tail -n +2 participants.tsv | \
awk -F '\t' '{print "protocol bgp AS" $3 " from template_rspeer {\n  description \"" $2 "\";\n  neighbor 44.74.128." $1 " as " $3 ";\n  import limit " $4 * 2 + 1 " action restart;\n}\n" }' | \
tee -a conf/RS1.bird.conf >>conf/RS2.bird.conf

tail -n +2 participants.tsv | \
awk -F '\t' '{print "protocol bgp AS" $3 " from template_rspeer {\n  description \"" $2 "\";\n  neighbor 2607:7C80:55:128::" $1 " as " $3 ";\n  import limit " $4 * 2 + 1 " action restart;\n}\n" }' | \
tee -a conf/RS1.bird6.conf >>conf/RS2.bird6.conf

